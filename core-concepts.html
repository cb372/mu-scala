<!DOCTYPE html><html><head><title>Mu-Scala: Core concepts</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="47 Degrees" /><meta name="description" content="A purely functional library for building RPC endpoint-based services" /><meta name="og:image" content="/mu-scala/img/poster.png" /><meta name="image" property="og:image" content="/mu-scala/img/poster.png" /><meta name="og:title" content="Mu-Scala: Core concepts" /><meta name="title" property="og:title" content="Mu-Scala: Core concepts" /><meta name="og:site_name" content="Mu-Scala" /><meta name="og:url" content="https://higherkindness.github.io/mu-scala/" /><meta name="og:type" content="website" /><meta name="og:description" content="A purely functional library for building RPC endpoint-based services" /><link rel="icon" type="image/png" href="/mu-scala/img/favicon.png" /><meta name="twitter:title" content="Mu-Scala: Core concepts" /><meta name="twitter:image" content="/mu-scala/img/poster.png" /><meta name="twitter:description" content="A purely functional library for building RPC endpoint-based services" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/mu-scala/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/mu-scala/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/mu-scala/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/mu-scala/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/mu-scala/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/mu-scala/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/mu-scala/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/mu-scala/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/mu-scala/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/mu-scala/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/mu-scala/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/mu-scala/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/mu-scala/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/mu-scala/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/mu-scala/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/mu-scala/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/mu-scala/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/mu-scala/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/mu-scala/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/mu-scala/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/mu-scala/highlight/styles/github-gist.css" /><link rel="stylesheet" href="/mu-scala/css/light-style.css" /><link rel="stylesheet" href="/mu-scala/css/mu-styles.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/mu-scala/" class="brand"><div class="brand-wrapper"></div><span>Mu-Scala</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav">                      </div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/cb372/mu-scala" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/cb372/mu-scala" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="cb372" data-github-repo="mu-scala"><div class="content-wrapper"><section><h1 id="core-concepts">Core concepts</h1>

<h2 id="about-grpc">About gRPC</h2>

<blockquote>
  <p><a href="https://grpc.io/about/">gRPC</a> is a modern, open source, and high-performance RPC framework that can run in any environment. It can efficiently connect services in and across data centers with pluggable support for load balancing, tracing, health checking, and authentication. It’s also applicable in the last mile of distributed computing to connect devices, mobile applications, and browsers to backend services.</p>
</blockquote>

<p>In this project, we are focusing on the <a href="https://github.com/grpc/grpc-java">Java gRPC</a> implementation.</p>

<p>In the upcoming sections, we’ll take a look at how we can implement RPC protocols (Messages and Services) in both <em>gRPC</em> and <em>Mu-RPC</em>.</p>

<h2 id="messages-and-services">Messages and Services</h2>

<h3 id="grpc">gRPC</h3>

<p>As you might know, <a href="https://grpc.io/">gRPC</a> uses protocol buffers (a.k.a. <em>protobuf</em>) by default:</p>

<ul>
  <li>As the Interface Definition Language (IDL) - for describing both the service interface and the structure of the payload messages. It is possible to use other alternatives if desired.</li>
  <li>For serializing/deserializing structured data - just as you define <a href="https://en.wikipedia.org/wiki/JSON">JSON</a> data with a <code class="highlighter-rouge">.json</code> file extension, with protobufs you define files with <code class="highlighter-rouge">.proto</code> as an extension.</li>
</ul>

<p>In the example given in the <a href="https://grpc.io/docs/guides/">gRPC guide</a>, you might have a proto file like this:</p>

<div class="language-protobuf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">Person</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int32</span> <span class="na">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="na">has_ponycopter</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then, once you’ve specified your data structures, you can use the protobuf compiler <code class="highlighter-rouge">protoc</code> to generate data access classes in your preferred language(s) from your proto definition.</p>

<p>Likewise, you can define <a href="https://grpc.io/">gRPC</a> services in your proto files, with RPC method parameters and return types specified as protocol buffer messages:</p>

<div class="language-protobuf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// The greeter service definition.
</span><span class="kd">service</span> <span class="n">Greeter</span> <span class="p">{</span>
  <span class="c1">// Sends a greeting
</span>  <span class="k">rpc</span> <span class="n">SayHello</span> <span class="p">(</span><span class="n">HelloRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">HelloReply</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// The request message containing the user's name.
</span><span class="kd">message</span> <span class="nc">HelloRequest</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// The response message containing the greetings
</span><span class="kd">message</span> <span class="nc">HelloReply</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="kd">message</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Correspondingly, <a href="https://grpc.io/">gRPC</a> uses protoc with a special <a href="https://grpc.io/">gRPC</a> plugin to generate code from your proto file for this <code class="highlighter-rouge">Greeter</code> RPC service.</p>

<p>You can find more information about Protocol Buffers in the <a href="https://developers.google.com/protocol-buffers/docs/overview">Protocol Buffers’ documentation</a>.</p>

<h3 id="mu-rpc">Mu-RPC</h3>

<p>In the previous section, we’ve seen an overview of what <a href="https://grpc.io/">gRPC</a> offers for defining protocols and generating code (compiling protocol buffers).
Now, we’ll show how <a href="https://github.com/higherkindness/mu">Mu</a> offers the same thing, but following FP principles.</p>

<p>First things first, the main difference with respect to <a href="https://grpc.io/">gRPC</a> is that your protocols, both messages and services,
will reside with your business-logic in your Scala files using <a href="https://github.com/scalamacros/paradise">scalamacros</a> annotations to set them up.
We’ll see more details on this shortly.</p>

<p>As a recommended approach, <a href="https://github.com/higherkindness/mu">Mu</a> generates the services and messages definitions in Scala code from <code class="highlighter-rouge">IDL</code> files.
We’ll check out this feature further in <a href="generate-sources-from-idl">this section</a>.</p>

<p>Let’s start looking at how to define the <code class="highlighter-rouge">Person</code> message that we saw previously.
Before starting, this is the Scala import we need:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">higherkindness.mu.rpc.protocol._</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">Person</code> would be defined as follows:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Message Example.
 *
 * @param name Person name.
 * @param id Person Id.
 * @param has_ponycopter Has Ponycopter check.
 */</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Person</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">has_ponycopter</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">)</span>
</code></pre></div></div>

<p>As we can see, this is quite simple. By the same token, let’s see now how the <code class="highlighter-rouge">Greeter</code> service would be translated to the <a href="https://github.com/higherkindness/mu">Mu</a> style (in your <code class="highlighter-rouge">.scala</code> file):</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">protocol1</span> <span class="o">{</span>

  <span class="cm">/**
    * The request message containing the user's name.
    * @param name User's name.
    */</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">HelloRequest</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

  <span class="cm">/**
    * The response message,
    * @param message Message containing the greetings.
    */</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">HelloReply</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

  <span class="nd">@service</span><span class="o">(</span><span class="nc">Protobuf</span><span class="o">)</span>
  <span class="k">trait</span> <span class="nc">Greeter</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>

    <span class="cm">/**
      * The greeter service definition.
      *
      * @param request Say Hello Request.
      * @return HelloReply.
      */</span>
    <span class="k">def</span> <span class="nf">sayHello</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">HelloRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">HelloReply</span><span class="o">]</span>

  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Naturally, the <a href="https://en.wikipedia.org/wiki/Remote_procedure_call">RPC</a> services are grouped in a <em>Tagless Final</em> algebra.
Therefore, you only need to concentrate on the API that you want to expose as abstract smart constructors, without worrying how they will be implemented.</p>

<p>In the above example, we can see that <code class="highlighter-rouge">sayHello</code> returns an <code class="highlighter-rouge">F[HelloReply]</code>. However, very often the services might:</p>

<ul>
  <li>Return an empty response.</li>
  <li>Receive an empty request.</li>
  <li>Return and receive a combination of both.</li>
</ul>

<p><code class="highlighter-rouge">Mu</code> provides an <code class="highlighter-rouge">Empty</code> object, defined at <code class="highlighter-rouge">mu.rpc.protocol</code>, that you might want to use for these purposes.</p>

<p>For instance:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">protocol2</span> <span class="o">{</span>

  <span class="cm">/**
   * The request message containing the user's name.
   * @param name User's name.
   */</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">HelloRequest</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

  <span class="cm">/**
   * The response message.
   * @param message Message containing the greetings.
   */</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">HelloReply</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

  <span class="nd">@service</span><span class="o">(</span><span class="nc">Protobuf</span><span class="o">)</span>
  <span class="k">trait</span> <span class="nc">Greeter</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>

    <span class="cm">/**
     * The greeter service definition.
     *
     * @param request Say Hello Request.
     * @return HelloReply.
     */</span>
    <span class="k">def</span> <span class="nf">sayHello</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">HelloRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">HelloReply</span><span class="o">]</span>

    <span class="k">def</span> <span class="nf">emptyResponse</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">HelloRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Empty.</span><span class="k">type</span><span class="o">]</span>

    <span class="k">def</span> <span class="nf">emptyRequest</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">Empty.</span><span class="k">type</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">HelloReply</span><span class="o">]</span>

    <span class="k">def</span> <span class="nf">emptyRequestRespose</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">Empty.</span><span class="k">type</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Empty.</span><span class="k">type</span><span class="o">]</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>We are also using some additional annotations:</p>

<ul>
  <li><code class="highlighter-rouge">@service(Protobuf)</code>: tags the trait as an <a href="https://en.wikipedia.org/wiki/Remote_procedure_call">RPC</a> service, in order to derive server and client code (macro expansion). It receives as its argument the type of serialization that will be used to encode/decode data. Our serialization type is <code class="highlighter-rouge">Protocol Buffers</code> in the example. <code class="highlighter-rouge">Avro</code> is also supported as another type of serialization.</li>
</ul>

<p>We’ll see more details about these and other annotations in the following sections.</p>

<h2 id="compression">Compression</h2>

<p><a href="https://github.com/higherkindness/mu">Mu</a> allows us to compress the data we are sending in our services. We can enable this compression either on the server or the client side.</p>

<p><a href="https://github.com/higherkindness/mu">Mu</a> supports <code class="highlighter-rouge">Gzip</code> as compression format.</p>

<p>For server side compression, we just have to add the annotation <code class="highlighter-rouge">Gzip</code> in our defined services.</p>

<p>Let’s see an example of a unary service:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">service1</span> <span class="o">{</span>

  <span class="nd">@service</span><span class="o">(</span><span class="nc">Protobuf</span><span class="o">,</span> <span class="nc">Gzip</span><span class="o">)</span>
  <span class="k">trait</span> <span class="nc">Greeter</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>

    <span class="cm">/**
     * Unary RPC with Gzip compression
     *
     * @param empty Client request.
     * @return empty server response.
     */</span>
    <span class="k">def</span> <span class="nf">emptyCompressed</span><span class="o">(</span><span class="n">empty</span><span class="k">:</span> <span class="kt">Empty.</span><span class="k">type</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Empty.</span><span class="k">type</span><span class="o">]</span>

  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>To enable compression on the client side, we just have to add an option to the client in the channel builder.</p>

<p>Let’s see an example of a client with the compression enabled.</p>

<p>Since <a href="https://github.com/higherkindness/mu">Mu</a> relies on <code class="highlighter-rouge">ConcurrentEffect</code> from the <a href="https://github.com/typelevel/cats-effect">cats-effect library</a>, we’ll need a runtime for executing our effects.</p>

<p>We’ll be using <code class="highlighter-rouge">IO</code> from <code class="highlighter-rouge">cats-effect</code>, but you can use any type that has a <code class="highlighter-rouge">ConcurrentEffect</code> instance.</p>

<p>For executing <code class="highlighter-rouge">IO</code> we need a <code class="highlighter-rouge">ContextShift[IO]</code> used for running <code class="highlighter-rouge">IO</code> instances and a <code class="highlighter-rouge">Timer[IO]</code> that is used for scheduling, let’s go ahead and create them.</p>

<p><em>Note:</em> You’d need an implicit <code class="highlighter-rouge">monix.execution.Scheduler</code> in the case you’re using Monix observables.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">trait</span> <span class="nc">CommonRuntime</span> <span class="o">{</span>

  <span class="k">val</span> <span class="nv">EC</span><span class="k">:</span> <span class="kt">scala.concurrent.ExecutionContext</span> <span class="o">=</span>
    <span class="nv">scala</span><span class="o">.</span><span class="py">concurrent</span><span class="o">.</span><span class="py">ExecutionContext</span><span class="o">.</span><span class="py">Implicits</span><span class="o">.</span><span class="py">global</span>

  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">timer</span><span class="k">:</span> <span class="kt">cats.effect.Timer</span><span class="o">[</span><span class="kt">cats.effect.IO</span><span class="o">]</span>     <span class="k">=</span> <span class="nv">cats</span><span class="o">.</span><span class="py">effect</span><span class="o">.</span><span class="py">IO</span><span class="o">.</span><span class="py">timer</span><span class="o">(</span><span class="nc">EC</span><span class="o">)</span>
  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">cs</span><span class="k">:</span> <span class="kt">cats.effect.ContextShift</span><span class="o">[</span><span class="kt">cats.effect.IO</span><span class="o">]</span> <span class="k">=</span> <span class="nv">cats</span><span class="o">.</span><span class="py">effect</span><span class="o">.</span><span class="py">IO</span><span class="o">.</span><span class="py">contextShift</span><span class="o">(</span><span class="nc">EC</span><span class="o">)</span>

<span class="o">}</span>
</code></pre></div></div>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">IO</span><span class="o">,</span> <span class="nc">Resource</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">higherkindness.mu.rpc._</span>
<span class="k">import</span> <span class="nn">higherkindness.mu.rpc.config._</span>
<span class="k">import</span> <span class="nn">higherkindness.mu.rpc.config.channel._</span>
<span class="k">import</span> <span class="nn">io.grpc.CallOptions</span>
<span class="k">import</span> <span class="nn">service1._</span>

<span class="k">trait</span> <span class="nc">ChannelImplicits</span> <span class="k">extends</span> <span class="nc">CommonRuntime</span> <span class="o">{</span>

  <span class="k">val</span> <span class="nv">channelFor</span><span class="k">:</span> <span class="kt">ChannelFor</span> <span class="o">=</span>
    <span class="nc">ConfigForAddress</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="s">"rpc.host"</span><span class="o">,</span> <span class="s">"rpc.port"</span><span class="o">).</span><span class="py">unsafeRunSync</span>

  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">serviceClient</span><span class="k">:</span> <span class="kt">Resource</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Greeter</span><span class="o">[</span><span class="kt">IO</span><span class="o">]]</span> <span class="k">=</span>
    <span class="nv">Greeter</span><span class="o">.</span><span class="py">client</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="n">channelFor</span><span class="o">,</span> <span class="n">options</span> <span class="k">=</span> <span class="nv">CallOptions</span><span class="o">.</span><span class="py">DEFAULT</span><span class="o">.</span><span class="py">withCompression</span><span class="o">(</span><span class="s">"gzip"</span><span class="o">))</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">implicits</span> <span class="k">extends</span> <span class="nc">ChannelImplicits</span>
</code></pre></div></div>

<h2 id="service-methods">Service Methods</h2>

<p>As <a href="https://grpc.io/">gRPC</a>, <a href="https://github.com/higherkindness/mu">Mu</a> allows you to define two main kinds of service methods:</p>

<ul>
  <li><strong>Unary RPC</strong>: the simplest way of communicating, one client request, and one server response.</li>
  <li><strong>Streaming RPC</strong>: similar to unary, but depending the kind of streaming, the client, server, or both will send back a stream of responses. There are three kinds of streaming, server, client and bidirectional streaming.</li>
</ul>

<p>Let’s complete our protocol’s example with an unary service method:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">service2</span> <span class="o">{</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">HelloRequest</span><span class="o">(</span><span class="n">greeting</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">HelloResponse</span><span class="o">(</span><span class="n">reply</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

  <span class="nd">@service</span><span class="o">(</span><span class="nc">Protobuf</span><span class="o">)</span>
  <span class="k">trait</span> <span class="nc">Greeter</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>

    <span class="cm">/**
     * Unary RPC where the client sends a single request to the server and gets a single response back,
     * just like a normal function call.
     *
     * https://grpc.io/docs/guides/concepts.html
     *
     * @param request Client request.
     * @return Server response.
     */</span>
    <span class="k">def</span> <span class="nf">sayHello</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">HelloRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">HelloResponse</span><span class="o">]</span>

  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>Here <code class="highlighter-rouge">sayHello</code> is our unary RPC.</p>

<p>In the <a href="streaming">Streaming section</a>, we are going to see all the streaming options.</p>

<h2 id="custom-codecs">Custom codecs</h2>

<p><a href="https://github.com/higherkindness/mu">Mu</a> allows you to use custom decoders and encoders. It creates implicit <code class="highlighter-rouge">Marshaller</code> instances for your messages using existing serializers/deserializers for the serialization type you’re using.</p>

<p>If you’re using <code class="highlighter-rouge">Protobuf</code>, <a href="https://github.com/higherkindness/mu">Mu</a> uses instances of <a href="https://github.com/47deg/pbdirect">PBDirect</a> for creating the <code class="highlighter-rouge">Marshaller</code> instances. For <code class="highlighter-rouge">Avro</code>, it uses instances of <a href="https://github.com/sksamuel/avro4s">Avro4s</a>.</p>

<p>Let’s see a couple of samples, one per each type of serialization. Suppose you want to serialize <code class="highlighter-rouge">java.time.LocalDate</code> as part of your messages in <code class="highlighter-rouge">String</code> format. With <code class="highlighter-rouge">Protobuf</code>, as we’ve mentioned, you need to provide the instances of <a href="https://github.com/47deg/pbdirect">PBDirect</a> for that type. Specifically, you need to provide a <code class="highlighter-rouge">PBScalarValueWriter</code> and a <code class="highlighter-rouge">PBScalarValueReader</code>.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">protocol3</span> <span class="o">{</span>

  <span class="k">import</span> <span class="nn">java.time._</span>
  <span class="k">import</span> <span class="nn">java.time.format._</span>

  <span class="k">import</span> <span class="nn">com.google.protobuf.</span><span class="o">{</span><span class="nc">CodedInputStream</span><span class="o">,</span> <span class="nc">CodedOutputStream</span><span class="o">}</span>
  <span class="k">import</span> <span class="nn">pbdirect._</span>

  <span class="k">import</span> <span class="nn">cats.syntax.contravariant._</span>
  <span class="k">import</span> <span class="nn">cats.syntax.functor._</span>

  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">localDateWriter</span><span class="k">:</span> <span class="kt">PBScalarValueWriter</span><span class="o">[</span><span class="kt">LocalDate</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">PBScalarValueWriter</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="py">contramap</span><span class="o">[</span><span class="kt">LocalDate</span><span class="o">](</span><span class="nv">_</span><span class="o">.</span><span class="py">format</span><span class="o">(</span><span class="nv">DateTimeFormatter</span><span class="o">.</span><span class="py">ISO_LOCAL_DATE</span><span class="o">))</span>

  <span class="k">implicit</span> <span class="k">val</span> <span class="nv">localDateReader</span><span class="k">:</span> <span class="kt">PBScalarValueReader</span><span class="o">[</span><span class="kt">LocalDate</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">PBScalarValueReader</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="py">map</span><span class="o">(</span><span class="n">string</span> <span class="k">=&gt;</span> <span class="nv">LocalDate</span><span class="o">.</span><span class="py">parse</span><span class="o">(</span><span class="n">string</span><span class="o">,</span> <span class="nv">DateTimeFormatter</span><span class="o">.</span><span class="py">ISO_LOCAL_DATE</span><span class="o">))</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">HelloRequest</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">date</span><span class="k">:</span> <span class="kt">LocalDate</span><span class="o">)</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">HelloReply</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

  <span class="nd">@service</span><span class="o">(</span><span class="nc">Protobuf</span><span class="o">)</span>
  <span class="k">trait</span> <span class="nc">Greeter</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>

    <span class="k">def</span> <span class="nf">sayHello</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">HelloRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">HelloReply</span><span class="o">]</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>For <code class="highlighter-rouge">Avro</code> the process is quite similar, but in this case we need to provide three instances of three <a href="https://github.com/sksamuel/avro4s">Avro4s</a> type classes: <code class="highlighter-rouge">SchemaFor</code>, <code class="highlighter-rouge">Encoder</code>, and <code class="highlighter-rouge">Decoder</code>.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">object</span> <span class="nc">protocol4</span> <span class="o">{</span>

  <span class="k">import</span> <span class="nn">java.time._</span>
  <span class="k">import</span> <span class="nn">java.time.format._</span>

  <span class="k">import</span> <span class="nn">com.sksamuel.avro4s._</span>
  <span class="k">import</span> <span class="nn">org.apache.avro.Schema</span>
  <span class="k">import</span> <span class="nn">org.apache.avro.Schema.Field</span>

  <span class="k">implicit</span> <span class="k">object</span> <span class="nc">LocalDateSchemaFor</span> <span class="k">extends</span> <span class="nc">SchemaFor</span><span class="o">[</span><span class="kt">LocalDate</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="nf">schema</span><span class="o">(</span><span class="n">fm</span><span class="k">:</span> <span class="kt">com.sksamuel.avro4s.FieldMapper</span><span class="o">)</span><span class="k">:</span> <span class="kt">Schema</span> <span class="o">=</span>
      <span class="nv">Schema</span><span class="o">.</span><span class="py">create</span><span class="o">(</span><span class="nv">Schema</span><span class="o">.</span><span class="py">Type</span><span class="o">.</span><span class="py">STRING</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">implicit</span> <span class="k">object</span> <span class="nc">LocalDateEncoder</span> <span class="k">extends</span> <span class="nc">Encoder</span><span class="o">[</span><span class="kt">LocalDate</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="nf">encode</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">LocalDate</span><span class="o">,</span> <span class="n">schema</span><span class="k">:</span> <span class="kt">Schema</span><span class="o">,</span> <span class="n">fm</span><span class="k">:</span> <span class="kt">FieldMapper</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span>
      <span class="nv">value</span><span class="o">.</span><span class="py">format</span><span class="o">(</span><span class="nv">DateTimeFormatter</span><span class="o">.</span><span class="py">ISO_LOCAL_DATE</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">implicit</span> <span class="k">object</span> <span class="nc">LocalDateDecoder</span> <span class="k">extends</span> <span class="nc">Decoder</span><span class="o">[</span><span class="kt">LocalDate</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">override</span> <span class="k">def</span> <span class="nf">decode</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Any</span><span class="o">,</span> <span class="n">schema</span><span class="k">:</span> <span class="kt">Schema</span><span class="o">,</span> <span class="n">fm</span><span class="k">:</span> <span class="kt">FieldMapper</span><span class="o">)</span><span class="k">:</span> <span class="kt">LocalDate</span> <span class="o">=</span>
      <span class="nv">LocalDate</span><span class="o">.</span><span class="py">parse</span><span class="o">(</span><span class="nv">value</span><span class="o">.</span><span class="py">toString</span><span class="o">(),</span> <span class="nv">DateTimeFormatter</span><span class="o">.</span><span class="py">ISO_LOCAL_DATE</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">HelloRequest</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">date</span><span class="k">:</span> <span class="kt">LocalDate</span><span class="o">)</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">HelloReply</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

  <span class="nd">@service</span><span class="o">(</span><span class="nc">Avro</span><span class="o">)</span>
  <span class="k">trait</span> <span class="nc">Greeter</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>

    <span class="k">def</span> <span class="nf">sayHello</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">HelloRequest</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">HelloReply</span><span class="o">]</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><a href="https://github.com/higherkindness/mu">Mu</a> provides serializers for <code class="highlighter-rouge">BigDecimal</code>, <code class="highlighter-rouge">BigDecimal</code> with tagged ‘precision’ and ‘scale’ (like <code class="highlighter-rouge">BigDecimal @@ (Nat._8, Nat._2)</code>), <code class="highlighter-rouge">java.time.LocalDate</code> and <code class="highlighter-rouge">java.time.LocalDateTime</code>. The only thing you need to do is add the following import to your service:</p>

<ul>
  <li><code class="highlighter-rouge">BigDecimal</code> in <code class="highlighter-rouge">Protobuf</code>
    <ul>
      <li><code class="highlighter-rouge">import higherkindness.mu.rpc.internal.encoders.pbd.bigDecimal._</code></li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">java.time.LocalDate</code>, <code class="highlighter-rouge">java.time.LocalDateTime</code> and <code class="highlighter-rouge">java.time.Instant</code> in <code class="highlighter-rouge">Protobuf</code>
    <ul>
      <li><code class="highlighter-rouge">import higherkindness.mu.rpc.internal.encoders.pbd.javatime._</code></li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">BigDecimal</code> in <code class="highlighter-rouge">Avro</code> (<strong>note</strong>: this encoder is not avro spec compliant)
    <ul>
      <li><code class="highlighter-rouge">import higherkindness.mu.rpc.internal.encoders.avro.bigdecimal._</code></li>
    </ul>
  </li>
  <li>Tagged <code class="highlighter-rouge">BigDecimal</code> in <code class="highlighter-rouge">Avro</code>
    <ul>
      <li><code class="highlighter-rouge">import higherkindness.mu.rpc.internal.encoders.avro.bigDecimalTagged._</code></li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">java.time.LocalDateTime</code> in <code class="highlighter-rouge">Avro</code>
    <ul>
      <li><code class="highlighter-rouge">import higherkindness.mu.rpc.internal.encoders.avro.javatime._</code></li>
    </ul>
  </li>
</ul>

<p>Mu also provides instances for <code class="highlighter-rouge">org.joda.time.LocalDate</code> and <code class="highlighter-rouge">org.joda.time.LocalDateTime</code>, but you need the <code class="highlighter-rouge">mu-rpc-marshallers-jodatime</code> extra dependency. See the <a href="/mu/scala/">main section</a> for the SBT instructions.</p>

<ul>
  <li><code class="highlighter-rouge">org.joda.time.LocalDate</code> and <code class="highlighter-rouge">org.joda.time.LocalDateTime</code> in <code class="highlighter-rouge">Protobuf</code>
    <ul>
      <li><code class="highlighter-rouge">import higherkindness.mu.rpc.marshallers.jodaTimeEncoders.pbd._</code></li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">org.joda.time.LocalDate</code> and <code class="highlighter-rouge">org.joda.time.LocalDateTime</code> in <code class="highlighter-rouge">Avro</code>
    <ul>
      <li><code class="highlighter-rouge">import higherkindness.mu.rpc.marshallers.jodaTimeEncoders.avro._</code></li>
    </ul>
  </li>
</ul>

<p><strong>Note</strong>: If you want to send one of these instances directly as a request or response through Avro, you need to provide an instance of <code class="highlighter-rouge">Marshaller</code>. <a href="https://github.com/higherkindness/mu">Mu</a> provides the marshallers for <code class="highlighter-rouge">BigDecimal</code>, <code class="highlighter-rouge">java.time.LocalDate</code>, <code class="highlighter-rouge">java.time.LocalDateTime</code>, <code class="highlighter-rouge">java.time.Instant</code>, <code class="highlighter-rouge">org.joda.time.LocalDate</code> and <code class="highlighter-rouge">org.joda.time.LocalDateTime</code> in a separate package:</p>
<ul>
  <li><code class="highlighter-rouge">BigDecimal</code> in <code class="highlighter-rouge">Avro</code>
    <ul>
      <li><code class="highlighter-rouge">import higherkindness.mu.rpc.internal.encoders.avro.bigdecimal.marshallers._</code></li>
    </ul>
  </li>
  <li>Tagged <code class="highlighter-rouge">BigDecimal</code> in <code class="highlighter-rouge">Avro</code> (<strong>note</strong>: this encoder is not avro spec compliant)
    <ul>
      <li><code class="highlighter-rouge">import higherkindness.mu.rpc.internal.encoders.avro.bigDecimalTagged.marshallers._</code></li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">java.time.LocalDate</code>, <code class="highlighter-rouge">java.time.LocalDateTime</code> and <code class="highlighter-rouge">java.time.Instant</code> in <code class="highlighter-rouge">Avro</code>
    <ul>
      <li><code class="highlighter-rouge">import higherkindness.mu.rpc.internal.encoders.avro.javatime.marshallers._</code></li>
    </ul>
  </li>
  <li><code class="highlighter-rouge">org.joda.time.LocalDate</code> and <code class="highlighter-rouge">org.joda.time.LocalDateTime</code> in <code class="highlighter-rouge">Avro</code>
    <ul>
      <li><code class="highlighter-rouge">import higherkindness.mu.rpc.marshallers.jodaTimeEncoders.avro.marshallers._</code></li>
    </ul>
  </li>
</ul>

</section></div></div></div></div><script src="/mu-scala/highlight/highlight.pack.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/protobuf.min.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash','protobuf']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: '47deg/mu'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/mu-scala/js/docs.js"></script></body></html>